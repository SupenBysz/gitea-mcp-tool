# gitea-mcp-tool - AI 工作指南

本文档定义 AI Agent 在 gitea-mcp-tool 项目中的工作规范。**项目级规范优先于 Wiki 通用规范**。

---

## 1. 项目概述

| 项目 | 内容 |
|------|------|
| **项目名称** | gitea-mcp-tool |
| **项目定位** | Universal MCP Server for Gitea，支持 Claude Desktop、Cline、Continue 等所有 MCP 客户端 |
| **当前版本** | v2.0.0-beta.0 |
| **仓库地址** | Kysion/gitea-mcp-tool |

### 技术栈

| 类型 | 技术 | 版本要求 |
|------|------|----------|
| **语言** | TypeScript | - |
| **运行时** | Node.js | >= 20 |
| **构建工具** | tsup | - |
| **测试框架** | vitest | - |
| **代码检查** | eslint | - |
| **日志** | pino | - |
| **包管理** | npm | - |

### 角色定义

| 项目 | 内容 |
|------|------|
| **角色** | 全栈工程师（全权负责） |
| **职责** | 工作者 + 验收者 |
| **权限** | 可直接合并到 dev |

### 身份配置

| 项目 | 内容 |
|------|------|
| **Gitea 用户名** | 按项目配置 |
| **Token 配置文件** | `.gitea-mcp.local.json` |

**新会话启动时**:
1. 确认 `.gitea-mcp.local.json` 存在且 Token 正确
2. 执行身份验证: `keactl user current`
3. 验证返回的 `username` 正确

---

## 2. 目录结构

```
gitea-mcp-tool/
├── src/                       # 源代码
│   ├── cli/                   # CLI 命令实现
│   │   └── commands/          # 各命令模块
│   ├── tools/                 # MCP 工具实现
│   │   ├── branch/            # 分支管理
│   │   ├── issue/             # Issue 管理
│   │   ├── pr/                # PR 管理
│   │   ├── repo/              # 仓库管理
│   │   ├── wiki/              # Wiki 管理
│   │   └── ...                # 其他工具
│   ├── types/                 # TypeScript 类型定义
│   │   └── gitea.ts           # Gitea API 类型
│   ├── gitea-client.ts        # Gitea API 客户端
│   ├── context-manager.ts     # 上下文管理
│   └── index.ts               # 入口文件
├── test/                      # 测试文件
├── docs/                      # 文档
├── config/                    # 配置文件
├── scripts/                   # 脚本工具
├── .gitea-mcp.json            # Gitea MCP 公共配置
├── .gitea-mcp.local.json      # Gitea MCP 私有配置（不提交）
├── package.json
├── tsconfig.json
├── tsup.config.ts
└── AGENTS.md                  # 本文件
```

---

## 3. 构建命令

### 开发构建

```bash
# 安装依赖
npm install

# 开发模式
npm run dev

# 生产构建
npm run build
```

### 代码检查

```bash
# ESLint 检查
npm run lint

# 自动修复
npm run lint:fix

# 类型检查
npm run typecheck
```

### 测试

```bash
# 运行测试
npm run test

# 本地打包测试
npm run local:publish
```

### 提交前验证（必须全部通过）

```bash
npm run build      # 构建成功
npm run test       # 测试通过
npm run typecheck  # 类型检查通过
npm run lint       # 代码风格检查
```

---

## 4. 核心铁律

### 1. 授权铁律（最高优先级）
- **所有文件操作必须获得用户明确授权**
- 用户提问 ≠ 授权修改，分析报告 ≠ 授权执行
- 未经授权的任何代码修改都是违规行为
- 违规时立即停止并道歉

### 2. 透明铁律
- 所有操作意图必须提前说明
- 不确定时必须询问，禁止假设用户意图
- 每个决策都需要解释理由

### 3. 最小化铁律
- 只做被要求的事情，不做额外"优化"
- 遵循 KISS 原则：保持简单
- 遵循 YAGNI 原则：不需要就不做

### 4. 可逆铁律
- 优先选择可撤销的操作
- 危险操作前必须确认并说明回退方案
- 批量操作需要分步确认

### 5. 诚实铁律
- 不确定时说"不确定"
- 不会时说"不会"
- 禁止编造信息或虚假承诺

---

## 5. 工单标签规范（重要）

> **标签是工单管理的核心**，必须严格按规范使用，不得随意创建或修改标签名称。

### 5.1 标签命名规则

| 规则 | 说明 | 示例 |
|------|------|------|
| **格式** | `{分类}/{值}` | `状态/进行中` |
| **语言** | 统一使用中文 | `类型/功能` 而非 `type/feature` |
| **大小写** | 不适用（中文） | - |

### 5.2 工单类型标签

| 标签 | 颜色 | 用途 | 说明 |
|------|------|------|------|
| `类型/需求` | 蓝色 | 需求工单 | 可拆分为多个功能子工单 |
| `类型/功能` | 绿色 | 功能开发 | 需求的子工单，具体任务 |
| `类型/BUG` | 红色 | Bug 修复 | 缺陷修复 |
| `类型/文档` | 灰色 | 文档任务 | README、Wiki 等文档更新 |
| `类型/重构` | 橙色 | 代码重构 | 不改变功能的代码优化 |
| `类型/测试` | 紫色 | 测试相关 | 测试用例编写/修复 |

### 5.3 工单状态标签

| 标签 | 颜色 | 触发时机 | 说明 |
|------|------|----------|------|
| `状态/待处理` | 蓝色 | 创建/分配工单时 | 初始状态 |
| `状态/进行中` | 黄色 | 开始工作时 | **必须先移除待处理标签** |
| `状态/已阻塞` | 红色 | 发现依赖阻塞时 | 需在评论说明阻塞原因 |
| `状态/待验收` | 紫色 | 工作完成后 | 提交工作总结后设置 |
| `状态/已完成` | 绿色 | 验收通过时 | 关闭工单时设置 |

### 5.4 工单优先级标签

| 标签 | 颜色 | 说明 | 响应要求 |
|------|------|------|----------|
| `优先级/P0-紧急` | 红色 | 线上故障、安全漏洞 | 立即处理 |
| `优先级/P1-高` | 橙色 | 核心功能、基础依赖 | 优先处理 |
| `优先级/P2-中` | 黄色 | 常规功能、优化改进 | 正常排期 |
| `优先级/P3-低` | 灰色 | 次要功能、技术债务 | 空闲处理 |

### 5.5 标签操作规范

| 操作 | 命令示例 | 说明 |
|------|----------|------|
| **添加标签** | `keactl issue label add <工单号> -l "状态/进行中"` | - |
| **移除标签** | `keactl issue label remove <工单号> -l "状态/待处理"` | - |
| **状态变更** | 先移除旧状态，再添加新状态 | **必须成对操作** |

### 5.6 标签使用铁律

| 序号 | 规则 |
|------|------|
| 1 | **工单必须同时具备**：类型标签 + 状态标签 + 优先级标签 |
| 2 | **状态标签唯一**：同一时间只能有一个状态标签 |
| 3 | **状态变更必须记录**：在评论区说明变更原因 |
| 4 | **禁止跳跃状态**：待处理 → 进行中 → 待验收 → 已完成 |
| 5 | **禁止自创标签**：只使用预定义的标签 |

---

## 6. 工单类型与命名

| 类型 | 标签 | 标题格式 | 示例 |
|------|------|----------|------|
| **需求** | `类型/需求` | `[Feature] 功能描述` | `[Feature] 添加 Wiki 搜索功能` |
| **功能** | `类型/功能` | `#父工单号-序号 任务描述` | `#42-1 实现搜索 API` |
| **BUG** | `类型/BUG` | `[Bug] 问题描述` | `[Bug] Wiki 分页返回错误` |
| **文档** | `类型/文档` | `[Docs] 文档描述` | `[Docs] 更新 API 文档` |
| **重构** | `类型/重构` | `[Refactor] 重构描述` | `[Refactor] 优化客户端结构` |

---

## 7. 工作流程

### 完整流程

| 阶段 | 操作 | 标签变更 | 评论/更新 |
|------|------|----------|-----------|
| **1. 创建工单** | 设置类型+状态+优先级标签 | +`类型/xxx` +`状态/待处理` +`优先级/Px-xxx` | - |
| **2. 开始工作** | 更新状态、创建分支 | -`状态/待处理` +`状态/进行中` | 工作计划 |
| **3. 工作阻塞** | 更新状态、记录依赖 | -`状态/进行中` +`状态/已阻塞` | 阻塞说明 |
| **4. 阻塞解除** | 更新状态 | -`状态/已阻塞` +`状态/进行中` | 解除说明 |
| **5. 工作结束** | 更新状态、推送代码 | -`状态/进行中` +`状态/待验收` | 工作总结 |
| **6. 验收通过** | 关闭工单、合并 PR | -`状态/待验收` +`状态/已完成` | 验收报告 |

### 启动检查清单

```markdown
- [ ] 确认是全新独立会话
- [ ] 确认当前项目正确（gitea-mcp-tool）
- [ ] 执行身份验证：`keactl user current`
- [ ] 确认已创建/切换到正确分支
- [ ] 确认分支命名符合规范
- [ ] 确认工单状态标签已更新（待处理 → 进行中）
```

### 验收检查清单

```markdown
- [ ] 功能符合需求
- [ ] npm run build 构建成功
- [ ] npm run test 测试通过
- [ ] npm run typecheck 类型检查通过
- [ ] npm run lint 代码风格检查通过
- [ ] 工单任务清单已勾选
- [ ] 工单状态标签已更新（进行中 → 待验收）
```

---

## 8. 评论模板

### 开始工作

```markdown
## 开始处理

**时间**: YYYY-MM-DD HH:mm
**分支**: feat/issue-xx-xxx
**状态**: 待处理 → 进行中

### 启动检查
- [x] 全新独立会话
- [x] 项目正确
- [x] 身份验证通过
- [x] 分支已创建
- [x] 状态标签已更新

### 工作计划
1. [计划步骤1]
2. [计划步骤2]
3. [计划步骤3]
```

### 工作总结 & 验收报告

```markdown
## 工作总结 & 验收报告

**完成时间**: YYYY-MM-DD HH:mm
**状态**: 待验收 → 已完成

### 工作内容
- [完成项1]
- [完成项2]

### 代码变更
- 新增: [文件列表]
- 修改: [文件列表]
- 删除: [文件列表]

### 代码分支
- 仓库: Kysion/gitea-mcp-tool
- 分支: feat/issue-xx-xxx

### 自检验收
- [x] 功能符合需求
- [x] npm run build 成功
- [x] npm run test 通过
- [x] npm run typecheck 通过
- [x] npm run lint 通过

### PR 信息
- PR #xx → dev
- 合并方式: squash
```

---

## 9. 分支与 PR 规范

### 分支命名

| 类型 | 格式 | 示例 |
|------|------|------|
| **功能** | `feat/issue-{工单号}-{简述}` | `feat/issue-42-add-wiki-search` |
| **修复** | `fix/issue-{工单号}-{简述}` | `fix/issue-55-beta-version` |
| **热修复** | `hotfix/issue-{工单号}-{简述}` | `hotfix/issue-60-crash` |
| **文档** | `docs/issue-{工单号}-{简述}` | `docs/issue-70-update-readme` |
| **重构** | `refactor/issue-{工单号}-{简述}` | `refactor/issue-80-client` |
| **子工单** | `feat/issue-{子}-p{父}-{简述}` | `feat/issue-43-p42-search-api` |

### PR 标题格式

```
{类型}({范围}): {描述} #{工单号}
```

示例：
- `feat(wiki): add search functionality #42`
- `fix(client): handle timeout error #55`
- `docs(readme): update installation guide #70`

### 提交信息格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type 类型**: `feat` | `fix` | `docs` | `refactor` | `test` | `chore`

---

## 10. 必须事项 & 禁止事项

### 必须事项

| 序号 | 事项 |
|------|------|
| 1 | 工作状态变更时**同步更新状态标签** |
| 2 | 开始/完成/阻塞时**在工单评论区记录** |
| 3 | 工作完成后**提交工作总结** |
| 4 | **确认身份后**再开始工作 |
| 5 | 在**独立会话**中处理工单 |
| 6 | 确认**分支正确**后再开始工作 |
| 7 | 代码提交前**通过全部检查**（build/test/typecheck/lint） |
| 8 | **标签成对操作**：先移除旧标签，再添加新标签 |

### 禁止事项

| 序号 | 事项 | 后果 |
|------|------|------|
| 1 | 未经授权修改任何文件 | 工作无效，需回退 |
| 2 | 直接推送到 main 分支 | 工作无效，需回退 |
| 3 | 同一会话处理多个工单 | 工作无效，需重做 |
| 4 | **使用 Mock/假数据冒充真实实现** | 工作无效，属欺骗行为 |
| 5 | **声称测试通过但未实际执行** | 工作无效，需重做 |
| 6 | 跳过测试提交代码 | 工作无效，需重做 |
| 7 | 执行破坏性操作（rm -rf、git push --force） | 严重违规 |
| 8 | **自创标签或使用非规范标签** | 需修正标签 |
| 9 | **状态标签跳跃变更** | 需补充中间状态记录 |

---

## 11. 工具优先级

| 优先级 | 工具 | 说明 |
|--------|------|------|
| 1 | **Gitea MCP** | MCP 协议工具，优先使用 |
| 2 | **keactl** | 命令行工具，功能完整 |
| 3 | **Gitea API** | REST API，作为兜底方案 |

### keactl 常用命令

```bash
# 身份验证
keactl user current

# 工单操作
keactl issue list
keactl issue get <工单号>
keactl issue comment <工单号> -m "评论内容"

# 标签操作
keactl issue label add <工单号> -l "状态/进行中"
keactl issue label remove <工单号> -l "状态/待处理"
```

---

## 12. 关联文档索引

### Wiki 文档（按需阅读）

```bash
keactl wiki get <页面名> -o Kysion -r ai-work-guidelines-wiki
```

| 场景 | Wiki 页面 |
|------|-----------|
| 了解完整工作流 | `工单工作流` |
| 查看完整评论模板 | `工单评论模板` |
| PR 详细规范 | `PR提交规范` |
| 跨项目依赖 | `跨项目依赖管理` |
| 违规处理 | `违规处理` |
| 代码规范 | `代码规范` |
| 测试规范 | `测试与质量` |

---

## 13. 规范优先级

当规范冲突时，按以下优先级处理：

1. **用户明确指示** - 最高优先级
2. **本文档（AGENTS.md）** - 项目级规范
3. **Wiki 完整规范** - 通用规范补充
4. **行业最佳实践** - 兜底参考

---

## 版本信息

| 项目 | 内容 |
|------|------|
| **版本** | v1.0 |
| **最后更新** | 2025-12-15 |
| **维护者** | AI Agent (全栈工程师) |
